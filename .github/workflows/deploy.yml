name: Deploy PeruJUG Site to GitHub Pages

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# Set permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # Build and test the application
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better caching
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      
      - name: Cache Quarkus build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-quarkus-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-quarkus
      
      - name: Verify Maven wrapper
        run: |
          chmod +x ./mvnw
          ./mvnw --version
      
      - name: Build with Maven
        run: |
          ./mvnw clean compile
        env:
          # Use GitHub Pages URL for production build
          QUARKUS_ROQ_SITE_URL: ${{ secrets.GITHUB_PAGES_URL || 'https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}' }}
      
      - name: Build production JAR
        run: |
          # Build production JAR using the static profile
          ./mvnw clean package -Pstatic
        env:
          # Use GitHub Pages URL for production build
          QUARKUS_ROQ_SITE_URL: ${{ secrets.GITHUB_PAGES_URL || 'https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}' }}
      
      - name: Verify JAR build
        run: |
          if [ ! -f "target/perujug-roq-1.0.0-SNAPSHOT.jar" ]; then
            echo "❌ JAR file was not generated"
            exit 1
          fi
          
          echo "✅ JAR file generated successfully"
          echo "📁 Build contents:"
          ls -la target/
          
          # Check for quarkus-app directory
          if [ ! -d "target/quarkus-app" ]; then
            echo "❌ quarkus-app directory not found"
            exit 1
          fi
          
          echo "✅ Quarkus application directory found"
      
      - name: Prepare static site for GitHub Pages
        run: |
          # Create static site directory
          mkdir -p target/site
          
          # Copy public assets
          cp -r public/* target/site/ 2>/dev/null || echo "No public directory found"
          
          # Copy content files
          cp -r content/* target/site/ 2>/dev/null || echo "No content directory found"
          
          # Create a basic index.html if it doesn't exist
          if [ ! -f "target/site/index.html" ]; then
            cat > target/site/index.html << 'EOF'
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>PeruJUG - Peru Java User Group</title>
                <link rel="stylesheet" href="materialize.css">
                <link rel="stylesheet" href="main.css">
            </head>
            <body>
                <div class="container">
                    <h1>PeruJUG - Peru Java User Group</h1>
                    <p>Welcome to the Peru Java User Group website!</p>
                    <p>This site is currently being updated. Please check back soon.</p>
                </div>
                <script src="js/jquery.min.js"></script>
                <script src="js/materialize.min.js"></script>
                <script src="init.js"></script>
            </body>
            </html>
            EOF
          fi
          
          echo "✅ Static site prepared for GitHub Pages"
          echo "📁 Site contents:"
          ls -la target/site/
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: target/site/
          retention-days: 1

  # Deploy to GitHub Pages
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: site-files
      
      - name: Verify downloaded artifacts
        run: |
          if [ ! -d "site-files" ]; then
            echo "❌ Site files not found"
            exit 1
          fi
          
          echo "✅ Site files downloaded successfully"
          echo "📁 Downloaded contents:"
          ls -la site-files/
          
          # Check for essential files
          if [ ! -f "site-files/index.html" ]; then
            echo "❌ index.html not found in downloaded files"
            exit 1
          fi
          
          echo "✅ Essential files verified"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: './site-files'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Verify deployment
        run: |
          echo "🚀 Deployment completed successfully!"
          echo "📱 Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "⏱️ Deployment time: ${{ steps.deployment.outputs.deployment_time }}"